#include <SDL/SDL.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>
#include <unistd.h>

// Simple 8x8 font bitmap for ASCII 32-127
static const unsigned char font8x8[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x18,0x3c,0x3c,0x18,0x18,0x00,0x18,0x00}, // space, !
    {0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,0x00}, {0x6c,0x6c,0xfe,0x6c,0xfe,0x6c,0x6c,0x00}, // ", #
    {0x18,0x3e,0x60,0x3c,0x06,0x7c,0x18,0x00}, {0x00,0xc6,0xcc,0x18,0x30,0x66,0xc6,0x00}, // $, %
    {0x38,0x6c,0x38,0x76,0xdc,0xcc,0x76,0x00}, {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00}, // &, '
    {0x0c,0x18,0x30,0x30,0x30,0x18,0x0c,0x00}, {0x30,0x18,0x0c,0x0c,0x0c,0x18,0x30,0x00}, // (, )
    {0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00}, {0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00}, // *, +
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, {0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00}, // ,, -
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, {0x06,0x0c,0x18,0x30,0x60,0xc0,0x80,0x00}, // ., /
    {0x7c,0xc6,0xce,0xde,0xf6,0xe6,0x7c,0x00}, {0x30,0x70,0x30,0x30,0x30,0x30,0xfc,0x00}, // 0, 1
    {0x78,0xcc,0x0c,0x38,0x60,0xcc,0xfc,0x00}, {0x78,0xcc,0x0c,0x38,0x0c,0xcc,0x78,0x00}, // 2, 3
    {0x1c,0x3c,0x6c,0xcc,0xfe,0x0c,0x1e,0x00}, {0xfc,0xc0,0xf8,0x0c,0x0c,0xcc,0x78,0x00}, // 4, 5
    {0x38,0x60,0xc0,0xf8,0xcc,0xcc,0x78,0x00}, {0xfc,0xcc,0x0c,0x18,0x30,0x30,0x30,0x00}, // 6, 7
    {0x78,0xcc,0xcc,0x78,0xcc,0xcc,0x78,0x00}, {0x78,0xcc,0xcc,0x7c,0x0c,0x18,0x70,0x00}, // 8, 9
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00}, {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00}, // :, ;
    {0x18,0x30,0x60,0xc0,0x60,0x30,0x18,0x00}, {0x00,0x00,0x7e,0x00,0x7e,0x00,0x00,0x00}, // <, =
    {0x60,0x30,0x18,0x0c,0x18,0x30,0x60,0x00}, {0x78,0xcc,0x0c,0x18,0x30,0x00,0x18,0x00}, // >, ?
    {0x7c,0xc6,0xde,0xde,0xde,0xc0,0x78,0x00}, {0x30,0x78,0xcc,0xcc,0xfc,0xcc,0xcc,0x00}, // @, A
    {0xfc,0x66,0x66,0x7c,0x66,0x66,0xfc,0x00}, {0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c,0x00}, // B, C
    {0xf8,0x6c,0x66,0x66,0x66,0x6c,0xf8,0x00}, {0xfe,0x62,0x68,0x78,0x68,0x62,0xfe,0x00}, // D, E
    {0xfe,0x62,0x68,0x78,0x68,0x60,0xf0,0x00}, {0x3c,0x66,0xc0,0xc0,0xce,0x66,0x3e,0x00}, // F, G
    {0xcc,0xcc,0xcc,0xfc,0xcc,0xcc,0xcc,0x00}, {0x78,0x30,0x30,0x30,0x30,0x30,0x78,0x00}, // H, I
    {0x1e,0x0c,0x0c,0x0c,0xcc,0xcc,0x78,0x00}, {0xe6,0x66,0x6c,0x78,0x6c,0x66,0xe6,0x00}, // J, K
    {0xf0,0x60,0x60,0x60,0x60,0x62,0xfe,0x00}, {0xc6,0xee,0xfe,0xfe,0xd6,0xc6,0xc6,0x00}, // L, M
    {0xc6,0xe6,0xf6,0xde,0xce,0xc6,0xc6,0x00}, {0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00}, // N, O
    {0xfc,0x66,0x66,0x7c,0x60,0x60,0xf0,0x00}, {0x7c,0xc6,0xc6,0xc6,0xda,0xcc,0x76,0x00}, // P, Q
    {0xfc,0x66,0x66,0x7c,0x6c,0x66,0xe6,0x00}, {0x78,0xcc,0xe0,0x70,0x1c,0xcc,0x78,0x00}, // R, S
    {0xfc,0xb4,0x30,0x30,0x30,0x30,0x78,0x00}, {0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0x78,0x00}, // T, U
    {0xcc,0xcc,0xcc,0xcc,0xcc,0x78,0x30,0x00}, {0xc6,0xc6,0xc6,0xd6,0xfe,0xee,0xc6,0x00}, // V, W
    {0xc6,0xc6,0x6c,0x38,0x6c,0xc6,0xc6,0x00}, {0xcc,0xcc,0xcc,0x78,0x30,0x30,0x78,0x00}, // X, Y
    {0xfe,0xc6,0x8c,0x18,0x32,0x66,0xfe,0x00}, {0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00}, // Z, [
    {0xc0,0x60,0x30,0x18,0x0c,0x06,0x02,0x00}, {0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00}, // \, ]
    {0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff}, // ^, _
};

SDL_Surface *screen = NULL;
FILE *log_file = NULL;
int cursor_x = 10, cursor_y = 10;

void draw_char(int x, int y, char c, uint32_t color) {
    if (c < 32 || c > 127) return;
    const unsigned char *bitmap = font8x8[c - 32];
    for (int i = 0; i < 8; i++) {
        for (int j = 0; j < 8; j++) {
            if (bitmap[i] & (1 << (7 - j))) {
                uint32_t *pixels = (uint32_t *)screen->pixels;
                pixels[(y + i) * screen->w + (x + j)] = color;
            }
        }
    }
}

void screen_printf(const char *format, ...) {
    char buffer[1024];
    va_list args;
    va_start(args, format);
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);

    // Print to log file
    if (log_file) fprintf(log_file, "%s", buffer);
    
    // Draw to SDL Screen
    for (int i = 0; buffer[i] != '\0'; i++) {
        if (buffer[i] == '\n') {
            cursor_x = 10;
            cursor_y += 10;
        } else {
            draw_char(cursor_x, cursor_y, buffer[i], 0xFFFFFF); // White text
            cursor_x += 8;
        }
    }
    SDL_Flip(screen);
}

void print_system_file(const char* path, const char* title) {
    FILE *f = fopen(path, "r");
    if (!f) return;
    screen_printf("\n> %s\n", title);
    char buffer[256];
    int lines = 0;
    while (fgets(buffer, sizeof(buffer), f) && lines < 8) { // Keep it short for screen
        screen_printf("%s", buffer);
        lines++;
    }
    fclose(f);
}

int main() {
    log_file = fopen("/mnt/info.txt", "w");
    if (SDL_Init(SDL_INIT_VIDEO) < 0) return 1;
    
    // Set resolution (Adjust 640x480 if your screen is smaller, e.g., 320x240)
    screen = SDL_SetVideoMode(640, 480, 32, SDL_SWSURFACE);
    if (!screen) return 1;

    SDL_FillRect(screen, NULL, 0x000000); // Black background

    screen_printf("GAMESTICK DIAGNOSTIC TOOL\n");
    screen_printf("========================\n");

    print_system_file("/proc/cpuinfo", "CPU INFO");
    print_system_file("/proc/version", "KERNEL");
    print_system_file("/proc/device-tree/model", "MODEL");
    
    screen_printf("\nDone. Check /mnt/info.txt\nExiting in 10s...");
    
    sync(); // Flush writes to SD card
    SDL_Delay(10000);

    if (log_file) fclose(log_file);
    SDL_Quit();
    return 0;
}
