#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <linux/fb.h>
#include <stdarg.h>
#include <string.h>

// 8x8 font bitmap (ASCII 32-127)
static const uint8_t font8x8[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x18,0x3c,0x3c,0x18,0x18,0x00,0x18,0x00}, // space, !
    {0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,0x00}, {0x6c,0x6c,0xfe,0x6c,0xfe,0x6c,0x6c,0x00}, // ", #
    {0x18,0x3e,0x60,0x3c,0x06,0x7c,0x18,0x00}, {0x00,0xc6,0xcc,0x18,0x30,0x66,0xc6,0x00}, // $, %
    {0x38,0x6c,0x38,0x76,0xdc,0xcc,0x76,0x00}, {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00}, // &, '
    {0x0c,0x18,0x30,0x30,0x30,0x18,0x0c,0x00}, {0x30,0x18,0x0c,0x0c,0x0c,0x18,0x30,0x00}, // (, )
    {0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00}, {0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00}, // *, +
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, {0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00}, // ,, -
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, {0x06,0x0c,0x18,0x30,0x60,0xc0,0x80,0x00}, // ., /
    {0x7c,0xc6,0xce,0xde,0xf6,0xe6,0x7c,0x00}, {0x30,0x70,0x30,0x30,0x30,0x30,0xfc,0x00}, // 0, 1
    {0x78,0xcc,0x0c,0x38,0x60,0xcc,0xfc,0x00}, {0x78,0xcc,0x0c,0x38,0x0c,0xcc,0x78,0x00}, // 2, 3
    {0x1c,0x3c,0x6c,0xcc,0xfe,0x0c,0x1e,0x00}, {0xfc,0xc0,0xf8,0x0c,0x0c,0xcc,0x78,0x00}, // 4, 5
    {0x38,0x60,0xc0,0xf8,0xcc,0xcc,0x78,0x00}, {0xfc,0xcc,0x0c,0x18,0x30,0x30,0x30,0x00}, // 6, 7
    {0x78,0xcc,0xcc,0x78,0xcc,0xcc,0x78,0x00}, {0x78,0xcc,0xcc,0x7c,0x0c,0x18,0x70,0x00}, // 8, 9
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00}, {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00}, // :, ;
    {0x18,0x30,0x60,0xc0,0x60,0x30,0x18,0x00}, {0x00,0x00,0x7e,0x00,0x7e,0x00,0x00,0x00}, // <, =
    {0x60,0x30,0x18,0x0c,0x18,0x30,0x60,0x00}, {0x78,0xcc,0x0c,0x18,0x30,0x00,0x18,0x00}, // >, ?
    {0x7c,0xc6,0xde,0xde,0xde,0xc0,0x78,0x00}, {0x30,0x78,0xcc,0xcc,0xfc,0xcc,0xcc,0x00}, // @, A
    {0xfc,0x66,0x66,0x7c,0x66,0x66,0xfc,0x00}, {0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c,0x00}, // B, C
    {0xf8,0x6c,0x66,0x66,0x66,0x6c,0xf8,0x00}, {0xfe,0x62,0x68,0x78,0x68,0x62,0xfe,0x00}, // D, E
    {0xfe,0x62,0x68,0x78,0x68,0x60,0xf0,0x00}, {0x3c,0x66,0xc0,0xc0,0xce,0x66,0x3e,0x00}, // F, G
    {0xcc,0xcc,0xcc,0xfc,0xcc,0xcc,0xcc,0x00}, {0x78,0x30,0x30,0x30,0x30,0x30,0x78,0x00}, // H, I
    {0x1e,0x0c,0x0c,0x0c,0xcc,0xcc,0x78,0x00}, {0xe6,0x66,0x6c,0x78,0x6c,0x66,0xe6,0x00}, // J, K
    {0xf0,0x60,0x60,0x60,0x60,0x62,0xfe,0x00}, {0xc6,0xee,0xfe,0xfe,0xd6,0xc6,0xc6,0x00}, // L, M
    {0xc6,0xe6,0xf6,0xde,0xce,0xc6,0xc6,0x00}, {0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00}, // N, O
    {0xfc,0x66,0x66,0x7c,0x60,0x60,0xf0,0x00}, {0x7c,0xc6,0xc6,0xc6,0xda,0xcc,0x76,0x00}, // P, Q
    {0xfc,0x66,0x66,0x7c,0x6c,0x66,0xe6,0x00}, {0x78,0xcc,0xe0,0x70,0x1c,0xcc,0x78,0x00}, // R, S
    {0xfc,0xb4,0x30,0x30,0x30,0x30,0x78,0x00}, {0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0x78,0x00}, // T, U
    {0xcc,0xcc,0xcc,0xcc,0xcc,0x78,0x30,0x00}, {0xc6,0xc6,0xc6,0xd6,0xfe,0xee,0xc6,0x00}, // V, W
    {0xc6,0xc6,0x6c,0x38,0x6c,0xc6,0xc6,0x00}, {0xcc,0xcc,0xcc,0x78,0x30,0x30,0x78,0x00}, // X, Y
    {0xfe,0xc6,0x8c,0x18,0x32,0x66,0xfe,0x00}, {0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00}, // Z, [
    {0xc0,0x60,0x30,0x18,0x0c,0x06,0x02,0x00}, {0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00}, // \, ]
    {0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff}, // ^, _
};

struct fb_var_screeninfo vinfo;
uint16_t *fbp = NULL;
int cursor_x = 20, cursor_y = 20;
FILE *log_file = NULL;

void draw_char(int x, int y, char c, uint16_t color) {
    if (c < 32 || c > 127) return;
    const uint8_t *bitmap = font8x8[c - 32];
    for (int i = 0; i < 8; i++) {
        for (int j = 0; j < 8; j++) {
            if (bitmap[i] & (1 << (7 - j))) {
                int px = x + j, py = y + i;
                if (px >= 0 && px < (int)vinfo.xres && py >= 0 && py < (int)vinfo.yres) {
                    fbp[py * vinfo.xres + px] = color;
                }
            }
        }
    }
}

void screen_printf(const char *format, ...) {
    char buffer[4096];
    va_list args;
    va_start(args, format);
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);

    if (log_file) { fprintf(log_file, "%s", buffer); fflush(log_file); }
    
    for (int i = 0; buffer[i] != '\0'; i++) {
        if (buffer[i] == '\n') {
            cursor_x = 20; cursor_y += 10;
        } else {
            draw_char(cursor_x, cursor_y, buffer[i], 0xFFFF);
            cursor_x += 8;
            if (cursor_x > (int)vinfo.xres - 20) { cursor_x = 20; cursor_y += 10; }
        }
        if (cursor_y > (int)vinfo.yres - 20) cursor_y = 20; 
    }
}

void run_cmd(const char* cmd) {
    screen_printf("\n========================================\n  %s\n========================================\n", cmd);
    FILE *fp = popen(cmd, "r");
    if (fp) {
        char buf[256];
        while (fgets(buf, sizeof(buf), fp)) screen_printf("%s", buf);
        pclose(fp);
    }
}

void dump_sys_file(const char* path) {
    screen_printf("\n========================================\n  %s\n========================================\n", path);
    FILE *f = fopen(path, "r");
    if (!f) { screen_printf("Error: Could not open %s\n", path); return; }
    char line[256];
    while (fgets(line, sizeof(line), f)) screen_printf("%s", line);
    fclose(f);
}

int main() {
    // Open log on SD card mount discovered in your previous run
    log_file = fopen("/mnt/sdcard/diag_full.txt", "w");
    if (!log_file) log_file = fopen("/mnt/info.txt", "w");

    int fbfd = open("/dev/fb0", O_RDWR);
    if (fbfd == -1) return 1;

    ioctl(fbfd, FBIOGET_VSCREENINFO, &vinfo);
    if (vinfo.xres == 0) { vinfo.xres = 1280; vinfo.yres = 720; vinfo.bits_per_pixel = 16; }

    long screensize = vinfo.xres * vinfo.yres * vinfo.bits_per_pixel / 8;
    fbp = (uint16_t *)mmap(0, screensize, PROT_READ | PROT_WRITE, MAP_SHARED, fbfd, 0);

    // Initial Clear
    for (int i = 0; i < vinfo.xres * vinfo.yres; i++) fbp[i] = 0x0000;

    screen_printf("RK-GAME MIPS DIAGNOSTIC REPORT\n");

    // --- Environment Info ---
    run_cmd("whoami");
    run_cmd("uname -a");
    run_cmd("pwd");
    run_cmd("df -h");
    run_cmd("mount");
    run_cmd("ls -l /");
    run_cmd("ls -l /bin");
    run_cmd("ls -l /tmp");
    run_cmd("ls -l /etc");
    run_cmd("ls -l /etc/init.d/");

    // --- System/Kernel Info ---
    dump_sys_file("/proc/version");
    dump_sys_file("/proc/cmdline");
    dump_sys_file("/proc/cpuinfo");
    dump_sys_file("/proc/meminfo");
    dump_sys_file("/proc/partitions");
    dump_sys_file("/proc/mounts");

    // --- Graphics/Framebuffer Info ---
    run_cmd("ls -l /dev/fb*");
    dump_sys_file("/sys/class/graphics/fb0/modes");
    run_cmd("fbset -i");

    // --- Boot Logs ---
    run_cmd("dmesg");

    screen_printf("\nALL DIAGNOSTICS COMPLETE. CHECK /mnt/sdcard/diag_full.txt\n");
    
    if (log_file) { fsync(fileno(log_file)); fclose(log_file); }
    sync();
    sleep(10);

    munmap(fbp, screensize);
    close(fbfd);
    return 0;
}
