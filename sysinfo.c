#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <linux/fb.h>
#include <stdarg.h>

// 8x8 font bitmap (ASCII 32-127)
static const uint8_t font8x8[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x18,0x3c,0x3c,0x18,0x18,0x00,0x18,0x00}, // space, !
    {0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,0x00}, {0x6c,0x6c,0xfe,0x6c,0xfe,0x6c,0x6c,0x00}, // ", #
    {0x18,0x3e,0x60,0x3c,0x06,0x7c,0x18,0x00}, {0x00,0xc6,0xcc,0x18,0x30,0x66,0xc6,0x00}, // $, %
    {0x38,0x6c,0x38,0x76,0xdc,0xcc,0x76,0x00}, {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00}, // &, '
    {0x0c,0x18,0x30,0x30,0x30,0x18,0x0c,0x00}, {0x30,0x18,0x0c,0x0c,0x0c,0x18,0x30,0x00}, // (, )
    {0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00}, {0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00}, // *, +
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, {0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00}, // ,, -
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, {0x06,0x0c,0x18,0x30,0x60,0xc0,0x80,0x00}, // ., /
    {0x7c,0xc6,0xce,0xde,0xf6,0xe6,0x7c,0x00}, {0x30,0x70,0x30,0x30,0x30,0x30,0xfc,0x00}, // 0, 1
    {0x78,0xcc,0x0c,0x38,0x60,0xcc,0xfc,0x00}, {0x78,0xcc,0x0c,0x38,0x0c,0xcc,0x78,0x00}, // 2, 3
    {0x1c,0x3c,0x6c,0xcc,0xfe,0x0c,0x1e,0x00}, {0xfc,0xc0,0xf8,0x0c,0x0c,0xcc,0x78,0x00}, // 4, 5
    {0x38,0x60,0xc0,0xf8,0xcc,0xcc,0x78,0x00}, {0xfc,0xcc,0x0c,0x18,0x30,0x30,0x30,0x00}, // 6, 7
    {0x78,0xcc,0xcc,0x78,0xcc,0xcc,0x78,0x00}, {0x78,0xcc,0xcc,0x7c,0x0c,0x18,0x70,0x00}, // 8, 9
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00}, {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00}, // :, ;
    {0x18,0x30,0x60,0xc0,0x60,0x30,0x18,0x00}, {0x00,0x00,0x7e,0x00,0x7e,0x00,0x00,0x00}, // <, =
    {0x60,0x30,0x18,0x0c,0x18,0x30,0x60,0x00}, {0x78,0xcc,0x0c,0x18,0x30,0x00,0x18,0x00}, // >, ?
    {0x7c,0xc6,0xde,0xde,0xde,0xc0,0x78,0x00}, {0x30,0x78,0xcc,0xcc,0xfc,0xcc,0xcc,0x00}, // @, A
    {0xfc,0x66,0x66,0x7c,0x66,0x66,0xfc,0x00}, {0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c,0x00}, // B, C
    {0xf8,0x6c,0x66,0x66,0x66,0x6c,0xf8,0x00}, {0xfe,0x62,0x68,0x78,0x68,0x62,0xfe,0x00}, // D, E
    {0xfe,0x62,0x68,0x78,0x68,0x60,0xf0,0x00}, {0x3c,0x66,0xc0,0xc0,0xce,0x66,0x3e,0x00}, // F, G
    {0xcc,0xcc,0xcc,0xfc,0xcc,0xcc,0xcc,0x00}, {0x78,0x30,0x30,0x30,0x30,0x30,0x78,0x00}, // H, I
    {0x1e,0x0c,0x0c,0x0c,0xcc,0xcc,0x78,0x00}, {0xe6,0x66,0x6c,0x78,0x6c,0x66,0xe6,0x00}, // J, K
    {0xf0,0x60,0x60,0x60,0x60,0x62,0xfe,0x00}, {0xc6,0xee,0xfe,0xfe,0xd6,0xc6,0xc6,0x00}, // L, M
    {0xc6,0xe6,0xf6,0xde,0xce,0xc6,0xc6,0x00}, {0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00}, // N, O
    {0xfc,0x66,0x66,0x7c,0x60,0x60,0xf0,0x00}, {0x7c,0xc6,0xc6,0xc6,0xda,0xcc,0x76,0x00}, // P, Q
    {0xfc,0x66,0x66,0x7c,0x6c,0x66,0xe6,0x00}, {0x78,0xcc,0xe0,0x70,0x1c,0xcc,0x78,0x00}, // R, S
    {0xfc,0xb4,0x30,0x30,0x30,0x30,0x78,0x00}, {0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0x78,0x00}, // T, U
    {0xcc,0xcc,0xcc,0xcc,0xcc,0x78,0x30,0x00}, {0xc6,0xc6,0xc6,0xd6,0xfe,0xee,0xc6,0x00}, // V, W
    {0xc6,0xc6,0x6c,0x38,0x6c,0xc6,0xc6,0x00}, {0xcc,0xcc,0xcc,0x78,0x30,0x30,0x78,0x00}, // X, Y
    {0xfe,0xc6,0x8c,0x18,0x32,0x66,0xfe,0x00}, {0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00}, // Z, [
    {0xc0,0x60,0x30,0x18,0x0c,0x06,0x02,0x00}, {0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00}, // \, ]
    {0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff}, // ^, _
};

struct fb_var_screeninfo vinfo;
uint16_t *fbp = NULL;
int cursor_x = 10, cursor_y = 10;
FILE *log_file = NULL;

void draw_char(int x, int y, char c, uint16_t color) {
    if (c < 32 || c > 127) return;
    const uint8_t *bitmap = font8x8[c - 32];
    for (int i = 0; i < 8; i++) {
        for (int j = 0; j < 8; j++) {
            if (bitmap[i] & (1 << (7 - j))) {
                int px = x + j;
                int py = y + i;
                if (px < vinfo.xres && py < vinfo.yres) {
                    fbp[py * vinfo.xres + px] = color;
                }
            }
        }
    }
}

void screen_printf(const char *format, ...) {
    char buffer[1024];
    va_list args;
    va_start(args, format);
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);

    if (log_file) fprintf(log_file, "%s", buffer);
    
    for (int i = 0; buffer[i] != '\0'; i++) {
        if (buffer[i] == '\n') {
            cursor_x = 10;
            cursor_y += 10;
        } else {
            draw_char(cursor_x, cursor_y, buffer[i], 0xFFFF); // White (RGB565)
            cursor_x += 8;
        }
    }
}

int main() {
    log_file = fopen("/mnt/info.txt", "w");
    int fbfd = open("/dev/fb0", O_RDWR);
    if (fbfd == -1) return 1;

    ioctl(fbfd, FBIOGET_VSCREENINFO, &vinfo);
    long screensize = vinfo.xres * vinfo.yres * vinfo.bits_per_pixel / 8;
    fbp = (uint16_t *)mmap(0, screensize, PROT_READ | PROT_WRITE, MAP_SHARED, fbfd, 0);

    // Clear screen (Black)
    for (int i = 0; i < vinfo.xres * vinfo.yres; i++) fbp[i] = 0x0000;

    screen_printf("MIPS DIRECT FRAMEBUFFER DIAGNOSTIC\n");
    screen_printf("==================================\n");

    // Print Diags
    FILE *f = fopen("/proc/cpuinfo", "r");
    if (f) {
        char buf[256];
        int count = 0;
        while (fgets(buf, 256, f) && count < 10) {
            screen_printf("%s", buf);
            count++;
        }
        fclose(f);
    }

    screen_printf("\nDone. Saved to /mnt/info.txt\nExiting in 10s...");
    
    sync();
    sleep(10);

    munmap(fbp, screensize);
    close(fbfd);
    if (log_file) fclose(log_file);
    return 0;
}
